<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RoadWatch - Real-time Monitoring</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* General Body Styles */
    body {
      margin: 0;
      font-family: 'Space Grotesk', sans-serif;
      background: #1a1a1a; /* Darker background */
      overflow: hidden;
    }

    /* Map Container */
    #map {
      height: 100vh;
      width: 100vw;
      z-index: 1;
    }
    /* Custom cursor for reporting mode */
    .crosshair-cursor {
        cursor: crosshair !important;
    }

    /* --- Glassmorphism Control Panel --- */
    .control-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      padding: 20px 25px;
      width: 280px;

      background: rgba(25, 25, 25, 0.7);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);

      color: #f0f0f0;
    }

    .control-panel h1 {
      margin: 0 0 5px 0;
      font-size: 1.9rem;
      font-weight: 700;
      color: #fff;
    }

    .control-panel p {
      margin: 0 0 20px 0;
      font-size: 0.9rem;
      color: #b0b0b0;
      font-weight: 400;
    }

    .divider {
      border: 0;
      height: 1px;
      background: rgba(255, 255, 255, 0.15);
      margin: 20px 0;
    }

    /* --- Layer Toggles --- */
    .layer-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .layer-control span {
      font-size: 1rem;
      font-weight: 500;
    }

    .switch {
      position: relative; display: inline-block; width: 50px; height: 28px;
    }
    .switch input { display: none; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 255, 255, 0.2); transition: .4s; border-radius: 28px;
    }
    .slider:before {
      position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: #007BFF; }
    input:checked + .slider:before { transform: translateX(22px); }

    /* --- Hazard Report Button & Form --- */
    #report-hazard-btn {
        width: 100%;
        padding: 12px;
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1rem;
        font-weight: 500;
        color: #fff;
        background-color: #007BFF;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.1s;
    }
    #report-hazard-btn:hover { background-color: #0056b3; }
    #report-hazard-btn:active { transform: scale(0.98); }
    #report-hazard-btn.reporting-active {
        background-color: #dc3545; /* Red for cancel */
    }

    .hazard-form select, .hazard-form button {
        width: 100%;
        padding: 8px;
        margin-top: 8px;
        border-radius: 5px;
        border: 1px solid #555;
        background: #333;
        color: #fff;
        font-family: 'Space Grotesk', sans-serif;
    }
     .hazard-form button {
        background: #007BFF;
        cursor: pointer;
        border: none;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="control-panel">
    <h1>RoadWatch</h1>
    <p>Real-time Monitoring</p>

    <hr class="divider">

    <div class="layer-control">
      <span>Show Buses</span>
      <label class="switch">
        <input type="checkbox" id="toggle-buses" checked>
        <span class="slider"></span>
      </label>
    </div>

    <div class="layer-control">
      <span>Show Potholes</span>
      <label class="switch">
        <input type="checkbox" id="toggle-potholes" checked>
        <span class="slider"></span>
      </label>
    </div>

    <hr class="divider">

    <button id="report-hazard-btn">Report Hazard</button>

  </div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const SUPABASE_URL = "https://jnjhkmlvfmynxyjypyie.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuamhrbWx2Zm15bnh5anlweWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTA4MjMsImV4cCI6MjA3MzgyNjgyM30.Xp1Y3UvqQhbuxP3KV_1dtW8Zff-yy0fA94G5O3wecOo";
  const POLL = 3000;

  // Initialize map with zoomControl set to false
  const map = L.map("map", {
      zoomControl: false
  }).setView([20, 0], 3);

  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
  }).addTo(map);

  const busMarkers = {};
  const busLayer = L.layerGroup().addTo(map);
  const potholeLayer = L.layerGroup().addTo(map);

  // Use the new SVG bus logo
  const busIcon = L.icon({
      iconUrl: "https://upload.wikimedia.org/wikipedia/commons/e/e6/Bus-logo.svg",
      iconSize: [35, 35],
      iconAnchor: [17, 17]
  });

  // --- Data Loading Functions ---

  async function loadBuses() {
    const url = `${SUPABASE_URL}/rest/v1/bus_location?select=*&order=ts.desc&limit=50`;
    try {
        const res = await fetch(url, { headers: { apikey: SUPABASE_KEY, Authorization: "Bearer " + SUPABASE_KEY } });
        const rows = await res.json();

        const latest = {};
        rows.forEach(r => { if (!latest[r.device_id]) latest[r.device_id] = r; });

        for (const r of Object.values(latest)) {
            if (!r.lat || !r.lon) continue;
            const pos = [r.lat, r.lon];
            if (busMarkers[r.device_id]) {
                busMarkers[r.device_id].setLatLng(pos);
            } else {
                busMarkers[r.device_id] = L.marker(pos, { icon: busIcon })
                    .addTo(busLayer)
                    .bindPopup(`<b>Bus ID:</b> ${r.device_id}`);
            }
        }
    } catch(error) {
        console.error("Failed to load bus data:", error);
    }
  }

  async function loadPotholes() {
    const url = `${SUPABASE_URL}/rest/v1/potholes?select=*&order=ts.desc&limit=200`;
    try {
        const res = await fetch(url, { headers: { apikey: SUPABASE_KEY, Authorization: "Bearer " + SUPABASE_KEY } });
        const rows = await res.json();
        potholeLayer.clearLayers();

        rows.forEach(r => {
            if (r.lat && r.lon) {
                let color = "green";
                if (r.severity === "high") color = "red";
                else if (r.severity === "medium") color = "orange";

                L.circleMarker([r.lat, r.lon], { radius: 7, color, fillColor: color, fillOpacity: 0.8, weight: 1.5 })
                  .addTo(potholeLayer)
                  .bindPopup(`<b>Pothole Report</b><br>Severity: ${r.severity}<br>Source: ${r.device_id}`);
            }
        });
    } catch(error) {
        console.error("Failed to load pothole data:", error);
    }
  }

  // --- NEW: Hazard Reporting Feature ---
  const reportBtn = document.getElementById('report-hazard-btn');
  let isReportingMode = false;
  let reportPopup = null;

  function enterReportingMode() {
      isReportingMode = true;
      reportBtn.textContent = "Cancel Reporting";
      reportBtn.classList.add('reporting-active');
      L.DomUtil.addClass(map.getContainer(), 'crosshair-cursor');
  }

  function exitReportingMode() {
      isReportingMode = false;
      reportBtn.textContent = "Report Hazard";
      reportBtn.classList.remove('reporting-active');
      L.DomUtil.removeClass(map.getContainer(), 'crosshair-cursor');
      if (reportPopup) {
          map.closePopup(reportPopup);
          reportPopup = null;
      }
  }

  reportBtn.addEventListener('click', () => {
      isReportingMode ? exitReportingMode() : enterReportingMode();
  });

  async function submitHazard(lat, lon, severity) {
      const url = `${SUPABASE_URL}/rest/v1/potholes`;
      try {
          const response = await fetch(url, {
              method: 'POST',
              headers: {
                  'apikey': SUPABASE_KEY,
                  'Authorization': `Bearer ${SUPABASE_KEY}`,
                  'Content-Type': 'application/json',
                  'Prefer': 'return=minimal'
              },
              body: JSON.stringify({
                  lat: lat,
                  lon: lon,
                  severity: severity,
                  device_id: 'web-report'
              })
          });
          if (!response.ok) throw new Error('Failed to submit report.');
          console.log("Hazard reported successfully!");
          loadPotholes(); // Refresh potholes layer to show the new one
      } catch (error) {
          console.error("Error submitting hazard:", error);
          alert("Could not submit report. Please try again.");
      }
  }

  map.on('click', function(e) {
      if (!isReportingMode) return;

      const lat = e.latlng.lat;
      const lon = e.latlng.lng;

      const formHtml = `
          <div class="hazard-form">
              <b>Report Hazard at this Location</b>
              <select id="severity-select">
                  <option value="low">Low Severity</option>
                  <option value="medium">Medium Severity</option>
                  <option value="high">High Severity</option>
              </select>
              <button id="submit-hazard-btn">Submit</button>
          </div>
      `;

      reportPopup = L.popup()
          .setLatLng(e.latlng)
          .setContent(formHtml)
          .openOn(map);

      // We need to get the button *after* the popup is created
      const submitBtn = document.getElementById('submit-hazard-btn');
      submitBtn.addEventListener('click', () => {
          const severity = document.getElementById('severity-select').value;
          submitHazard(lat, lon, severity);
          exitReportingMode();
      });
  });

  // --- UI Toggles ---
  document.getElementById('toggle-buses').addEventListener('change', (e) => {
    map.hasLayer(busLayer) ? map.removeLayer(busLayer) : map.addLayer(busLayer);
  });

  document.getElementById('toggle-potholes').addEventListener('change', (e) => {
    map.hasLayer(potholeLayer) ? map.removeLayer(potholeLayer) : map.addLayer(potholeLayer);
  });

  // --- Initial Load & Polling ---
  function pollData() {
      loadBuses();
      loadPotholes();
  }
  setInterval(pollData, POLL);
  pollData();

</script>
</body>
</html>
